import{u as E,r,s}from"./index-DZbrHQV2.js";const q=()=>{const{user:i}=E(),[C,u]=r.useState(null),[g,c]=r.useState(null),[v,m]=r.useState([]);r.useEffect(()=>{i!=null&&i.id&&s.auth.getUser().then(({data:{user:n}})=>{n&&s.from("call_invitations").select("id").limit(1).then(({error:e})=>{var l;if(e&&((l=e.message)!=null&&l.includes('relation "call_invitations" does not exist'))){console.warn("âš ï¸ call_invitations table not found. Call invitations will not work until table is created.");return}console.log("ðŸ“ž Creating call invitation channel for user:",n.id);const t=s.channel(`call_invitations_${n.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"call_invitations",filter:`to_user_id=eq.${n.id}`},o=>{console.log("ðŸ“ž Incoming call invitation:",o.new),console.log("ðŸ“ž Payload details:",{event:o.eventType,new:o.new,old:o.old});const a=o.new;u(a)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"call_invitations",filter:`to_user_id=eq.${n.id}`},o=>{console.log("ðŸ“ž Call invitation updated:",o.new);const a=o.new;a.status==="accepted"?c(null):a.status==="rejected"?(c(null),alert(`${f(a.fromUserId)} rejected your call`)):a.status==="ended"&&(u(null),c(null))}).subscribe(o=>{console.log("ðŸ“ž Channel subscription status:",o)});return()=>{console.log("ðŸ“ž Removing call invitation channel"),s.removeChannel(t)}})})},[i==null?void 0:i.id]),r.useEffect(()=>{if(!(i!=null&&i.id)||!g)return;const n=s.channel(`call_responses_${g.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"call_invitations",filter:`id=eq.${g.id}`},e=>{console.log("ðŸ“ž Call response received:",e.new);const t=e.new;t.status==="accepted"?c(null):t.status==="rejected"&&(c(null),alert(`${f(t.toUserId)} rejected your call`))}).subscribe();return()=>{s.removeChannel(n)}},[i==null?void 0:i.id,g]);const f=n=>{const e=v.find(t=>t.id===n);return(e==null?void 0:e.name)||"Unknown User"},h=r.useCallback(async(n,e,t)=>{var o;const{data:{user:l}}=await s.auth.getUser();if(!(l!=null&&l.id))return console.error("No auth user ID available"),null;try{console.log("ðŸ“ž Sending call invitation:",{from:l.id,to:n,type:e});const{data:a,error:d}=await s.from("call_invitations").insert({from_user_id:l.id,to_user_id:n,call_type:e,status:"pending",offer:t?JSON.stringify(t):null}).select().single();if(d){if(console.error("Database error:",d),(o=d.message)!=null&&o.includes('relation "call_invitations" does not exist'))return alert("Call invitations table not set up yet. Please run the SQL setup script in Supabase."),null;throw d}return console.log("ðŸ“ž Call invitation sent successfully:",a),c(a),setTimeout(()=>{console.log("â° Call timeout - auto rejecting"),_(a.id)},6e4),a.id}catch(a){return console.error("Error sending call invitation:",a),alert(`Failed to send call: ${a.message||"Unknown error"}`),null}},[]),w=r.useCallback(async(n,e)=>{try{const{error:t}=await s.from("call_invitations").update({status:"accepted",answer:e?JSON.stringify(e):null}).eq("id",n);if(t)throw t;console.log("ðŸ“ž Call invitation accepted"),u(null)}catch(t){console.error("Error accepting call invitation:",t)}},[]),_=r.useCallback(async n=>{try{const{error:e}=await s.from("call_invitations").update({status:"rejected"}).eq("id",n);if(e)throw e;console.log("ðŸ“ž Call invitation rejected"),u(null)}catch(e){console.error("Error rejecting call invitation:",e)}},[]),p=r.useCallback(async n=>{try{const{error:e}=await s.from("call_invitations").update({status:"ended"}).eq("id",n);if(e)throw e;console.log("ðŸ“ž Call ended"),u(null),c(null)}catch(e){console.error("Error ending call:",e)}},[]),b=r.useCallback(async(n,e)=>{try{const{data:t,error:l}=await s.from("call_invitations").select("ice_candidates").eq("id",n).single();if(l)throw l;const a=[...(t==null?void 0:t.ice_candidates)||[],e],{error:d}=await s.from("call_invitations").update({ice_candidates:a}).eq("id",n);if(d)throw d;console.log("ðŸ§Š ICE candidate sent")}catch(t){console.error("Error sending ICE candidate:",t)}},[]),y=r.useCallback(async()=>{try{const{data:n,error:e}=await s.from("profiles").select("id, user_id, name, avatar_url, is_online").eq("is_online",!0).neq("user_id",i==null?void 0:i.id);if(e)throw e;const t=n.map(l=>({id:l.user_id,name:l.name,avatar:l.avatar_url,isOnline:l.is_online}));return m(t),t}catch(n){return console.error("Error getting online users:",n),[]}},[i==null?void 0:i.id]);return{incomingCall:C,outgoingCall:g,callUsers:v,sendCallInvitation:h,acceptCallInvitation:w,rejectCallInvitation:_,endCall:p,sendIceCandidate:b,getOnlineUsers:y}};export{q as u};
