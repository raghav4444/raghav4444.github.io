import{r as n,s as U,j as e,u as me,R as De}from"./index-DZbrHQV2.js";import{X as oe}from"./x-DHTgq_OJ.js";import{S as ce}from"./search-DGLrhYib.js";import{U as ee}from"./user-k204x7C2.js";import{C as be}from"./clock-Dr9If8uH.js";import{M as ue}from"./message-circle-CM7cnG0a.js";import{P as Ae}from"./plus-CsL2Ha1A.js";import{u as Ue}from"./useCallSignaling-CR2B2Bj4.js";import{P as ie,a as ve}from"./phone-D7NiQMiT.js";import{V as de}from"./video-C7K7o1Ih.js";import{M as Me}from"./mic-BJtR_FXb.js";import{M as $e,V as Re,a as Le}from"./video-off-D8jZbii1.js";import{c as fe}from"./createLucideIcon-z6xmPMoH.js";import{I as Fe,F as Pe}from"./image-Dc2j2fby.js";import{P as xe,S as Ve}from"./send-BhgiBxFq.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=fe("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=fe("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=fe("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]),ze=()=>{const[r,h]=n.useState([]),[b,d]=n.useState(!1),[p,x]=n.useState(null),M=n.useCallback(async k=>{if(!k.trim()){h([]);return}d(!0),x(null);try{console.log("Searching for users with query:",k);const{data:N,error:y}=await U.from("profiles").select(`
          id,
          name,
          email,
          college,
          branch,
          year,
          avatar_url
        `).or(`name.ilike.%${k}%,email.ilike.%${k}%`).limit(20);if(y)throw console.error("Search error:",y),y;console.log("Search results:",N);const i=(N||[]).map(I=>{var D;return{id:I.id,name:I.name,username:((D=I.email)==null?void 0:D.split("@")[0])||I.name.toLowerCase().replace(/\s+/g,""),avatar:I.avatar_url,college:I.college,branch:I.branch,year:I.year,isOnline:!1,lastSeen:void 0}});console.log("Mapped results:",i),h(i)}catch(N){console.error("Error searching users:",N),x(N instanceof Error?N.message:"Failed to search users"),h([])}finally{d(!1)}},[]),L=n.useCallback(()=>{h([]),x(null)},[]);return{searchResults:r,loading:b,error:p,searchUsers:M,clearSearch:L}},We=({onUserSelect:r,onClose:h})=>{const[b,d]=n.useState(""),{searchResults:p,loading:x,error:M,searchUsers:L,clearSearch:k}=ze(),N=n.useRef(null);n.useEffect(()=>{const i=setTimeout(()=>{b.trim()?L(b):k()},300);return()=>clearTimeout(i)},[b,L,k]),n.useEffect(()=>{const i=I=>{N.current&&!N.current.contains(I.target)&&h()};return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[h]);const y=i=>{if(!i)return"Unknown";const D=Math.floor((new Date().getTime()-i.getTime())/(1e3*60));return D<1?"Just now":D<60?`${D}m ago`:D<1440?`${Math.floor(D/60)}h ago`:`${Math.floor(D/1440)}d ago`};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{ref:N,className:"bg-[#161b22] rounded-xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-xl border border-gray-800",children:[e.jsxs("div",{className:"p-6 border-b border-gray-800 bg-[#161b22]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Start a conversation"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Find someone to chat with"})]}),e.jsx("button",{onClick:h,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(oe,{className:"w-5 h-5 text-gray-400"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by username, name, or email...",value:b,onChange:i=>d(i.target.value),className:"w-full pl-10 pr-4 py-3 bg-[#0d1117] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",autoFocus:!0})]})]}),e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[x&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}),M&&e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(oe,{className:"w-6 h-6 text-red-400"})}),e.jsx("p",{className:"text-red-400 text-sm",children:M})]}),!x&&!M&&p.length===0&&b&&e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(ee,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"No users found"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Try a different search term"})]}),!x&&!M&&p.length>0&&e.jsx("div",{className:"p-2",children:p.map((i,I)=>e.jsx("button",{onClick:()=>{console.log("ðŸ” UserSearch: User clicked:",i),r(i)},className:"w-full p-4 hover:bg-gray-800 transition-colors text-left rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center",children:i.avatar?e.jsx("img",{src:i.avatar,alt:i.name,className:"w-12 h-12 rounded-full object-cover"}):e.jsx("span",{className:"text-gray-300 font-medium",children:i.name?i.name[0].toUpperCase():"?"})}),i.isOnline&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-[#161b22]"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx("p",{className:"text-white font-medium truncate",children:i.name}),e.jsxs("span",{className:"text-xs text-gray-400 bg-gray-800 px-2 py-1 rounded-full",children:["@",i.username]})]}),e.jsxs("p",{className:"text-gray-400 text-sm truncate mb-1",children:[i.college&&i.college.length>15?`${i.college.substring(0,15)}...`:i.college," â€¢ ",i.branch," â€¢ Year ",i.year]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(be,{className:"w-3 h-3 text-gray-500"}),e.jsx("span",{className:"text-xs text-gray-500",children:i.isOnline?e.jsx("span",{className:"text-green-400 font-medium",children:"Online now"}):`Last seen ${y(i.lastSeen)}`})]})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 bg-blue-600 hover:bg-blue-700 rounded-full flex items-center justify-center transition-colors",children:e.jsx(ue,{className:"w-5 h-5 text-white"})})})]})},i.id))})]})]})})},Be=({onConversationSelect:r,chatHook:h})=>{const{user:b}=me(),{conversations:d,loading:p,fetchConversations:x,startConversation:M}=h,[L,k]=n.useState(!1),[N,y]=n.useState("");n.useEffect(()=>{console.log("ðŸ” ChatList: Conversations state updated:",{length:d.length,conversations:d.map(g=>({id:g.id,participantsCount:g.participants.length}))})},[d]);const i=async g=>{console.log("ðŸ” User selected:",g);try{const l=await M(g.id);if(console.log("ðŸ” Conversation ID:",l),l){const m=d.find(v=>v.id===l);console.log("ðŸ” Found conversation:",m),m?r(m):(console.log("ðŸ”„ Conversation not found, refreshing..."),await x())}else console.log("âŒ Failed to create conversation")}catch(l){console.error("âŒ Error starting conversation:",l)}k(!1)},I=g=>{r(g)},D=g=>{if(!g.lastMessage)return"No messages yet";const l=g.lastMessage,m=l.sender.id===(b==null?void 0:b.id)?"You":l.sender.name;return l.messageType==="text"?`${m}: ${l.content}`:l.messageType==="image"?`${m}: ðŸ“· Image`:l.messageType==="file"?`${m}: ðŸ“Ž ${l.fileName}`:`${m}: Message`},A=g=>{const m=Math.floor((new Date().getTime()-g.getTime())/(1e3*60));return m<1?"Just now":m<60?`${m}m`:m<1440?`${Math.floor(m/60)}h`:m<10080?`${Math.floor(m/1440)}d`:g.toLocaleDateString()},P=g=>g.participants.find(l=>l.id!==(b==null?void 0:b.id)),j=d.filter(g=>{const l=P(g);return l?l.name.toLowerCase().includes(N.toLowerCase())||D(g).toLowerCase().includes(N.toLowerCase()):!1});return e.jsxs("div",{className:"flex flex-col h-full bg-[#161b22]",children:[e.jsxs("div",{className:"p-4 border-b border-gray-800 bg-[#161b22]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-xl font-semibold text-white",children:"Messages"}),e.jsx("button",{onClick:()=>k(!0),className:"p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors",children:e.jsx(Ae,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:N,onChange:g=>y(g.target.value),className:"w-full pl-10 pr-4 py-2 bg-[#0d1117] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0",children:[p&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}),!p&&j.length===0&&!N&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(ue,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"No conversations yet"}),e.jsx("p",{className:"text-gray-400 text-sm mb-6",children:"Start a conversation with someone from your college"}),e.jsx("button",{onClick:()=>k(!0),className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Start Chatting"})]}),!p&&j.length===0&&N&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(ce,{className:"w-8 h-8 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"No conversations found"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Try a different search term"})]}),!p&&j.length>0&&e.jsx("div",{className:"p-2",children:j.map(g=>{const l=P(g);return l?e.jsx("button",{onClick:()=>I(g),className:"w-full p-3 hover:bg-gray-800 transition-colors text-left rounded-lg mb-1",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center",children:l.avatar?e.jsx("img",{src:l.avatar,alt:l.name,className:"w-12 h-12 rounded-full object-cover"}):e.jsx(ee,{className:"w-6 h-6 text-gray-400"})}),l.lastActive&&new Date().getTime()-l.lastActive.getTime()<3e5&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-[#161b22]"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-white font-medium truncate",children:l.name}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs text-gray-400",children:A(g.updatedAt)}),g.unreadCount>0&&e.jsx("div",{className:"w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center",children:g.unreadCount>9?"9+":g.unreadCount})]})]}),e.jsx("p",{className:"text-sm text-gray-400 truncate",children:D(g)}),e.jsxs("div",{className:"flex items-center space-x-1 mt-1",children:[e.jsx(be,{className:"w-3 h-3 text-gray-500 flex-shrink-0"}),e.jsxs("span",{className:"text-xs text-gray-500 truncate",children:[l.college&&l.college.length>10?`${l.college.substring(0,10)}...`:l.college," â€¢ ",l.branch]})]})]})]})},g.id):null})})]}),L&&e.jsx(We,{onUserSelect:i,onClose:()=>k(!1)})]})},Ke=()=>{const[r,h]=n.useState({isInCall:!1,isCallActive:!1,isVideoEnabled:!0,isAudioEnabled:!0,isScreenSharing:!1,callType:null,remoteStream:null,localStream:null,peerConnection:null,currentInvitation:null}),b=n.useRef(null),d=n.useRef(null),p=n.useRef(null),{incomingCall:x,outgoingCall:M,callUsers:L,sendCallInvitation:k,acceptCallInvitation:N,rejectCallInvitation:y,endCall:i,sendIceCandidate:I,getOnlineUsers:D}=Ue(),A={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},P=n.useCallback(()=>{const s=new RTCPeerConnection(A);return p.current=s,s.ontrack=a=>{console.log("Received remote stream:",a.streams[0]),h(o=>({...o,remoteStream:a.streams[0],isCallActive:!0}))},s.onicecandidate=a=>{a.candidate&&console.log("ICE candidate:",a.candidate)},s.onconnectionstatechange=()=>{console.log("Connection state:",s.connectionState),s.connectionState==="connected"?h(a=>({...a,isCallActive:!0})):(s.connectionState==="disconnected"||s.connectionState==="failed"||s.connectionState==="closed")&&i()},s},[]),j=n.useCallback(async(s=!0,a=!0)=>{try{const o={video:s?{width:{ideal:1280},height:{ideal:720},facingMode:"user"}:!1,audio:a},_=await navigator.mediaDevices.getUserMedia(o);return h(E=>({...E,localStream:_})),b.current&&(b.current.srcObject=_),_}catch(o){throw console.error("Error accessing media devices:",o),o}},[]),g=n.useCallback(async(s,a)=>{try{console.log(`ðŸ“ž Starting ${a} call with ${s.name} (ID: ${s.id})`),h(q=>({...q,isInCall:!0,callType:a})),console.log("ðŸŽ¥ Getting local media...");const o=await j(a==="video",!0);console.log("âœ… Local media obtained"),console.log("ðŸ”— Creating peer connection...");const _=P();console.log("âœ… Peer connection created"),o.getTracks().forEach(q=>{_.addTrack(q,o)}),console.log("ðŸ“ Creating offer...");const E=await _.createOffer();await _.setLocalDescription(E),console.log("âœ… Offer created and set"),console.log("ðŸ“¤ Sending call invitation...");const R=await k(s.id,a,E);if(R)h(q=>({...q,currentInvitation:{id:R}})),console.log("âœ… Call invitation sent successfully, ID:",R);else throw new Error("Failed to send call invitation - no invitation ID returned")}catch(o){console.error("âŒ Error starting call:",o),alert(`Failed to start call: ${o.message||"Unknown error"}`),h(_=>({..._,isInCall:!1,callType:null,currentInvitation:null}))}},[j,P,k]),l=n.useCallback(async()=>{if(x)try{console.log(`Accepting ${x.callType} call from ${x.fromUserId}`);const s=await j(x.callType==="video",!0),a=P();s.getTracks().forEach(_=>{a.addTrack(_,s)}),x.offer&&await a.setRemoteDescription(x.offer);const o=await a.createAnswer();await a.setLocalDescription(o),await N(x.id,o),h(_=>({..._,isCallActive:!0,callType:x.callType,currentInvitation:x}))}catch(s){console.error("Error accepting call:",s),x&&await y(x.id)}},[x,j,P,N,y]),m=n.useCallback(async()=>{x&&(console.log("Rejecting incoming call"),await y(x.id),h(s=>({...s,isInCall:!1,callType:null,currentInvitation:null})))},[x,y]),v=n.useCallback(async()=>{console.log("Ending call"),r.currentInvitation&&await i(r.currentInvitation.id),r.localStream&&r.localStream.getTracks().forEach(s=>s.stop()),p.current&&(p.current.close(),p.current=null),h({isInCall:!1,isCallActive:!1,isVideoEnabled:!0,isAudioEnabled:!0,isScreenSharing:!1,callType:null,remoteStream:null,localStream:null,peerConnection:null,currentInvitation:null})},[r.localStream,r.currentInvitation,i]),c=n.useCallback(()=>{if(r.localStream){const s=r.localStream.getAudioTracks()[0];s&&(s.enabled=!s.enabled,h(a=>({...a,isAudioEnabled:s.enabled})))}},[r.localStream]),T=n.useCallback(()=>{if(r.localStream){const s=r.localStream.getVideoTracks()[0];s&&(s.enabled=!s.enabled,h(a=>({...a,isVideoEnabled:s.enabled})))}},[r.localStream]),u=n.useCallback(async()=>{try{if(r.isScreenSharing){if(r.localStream){const a=r.localStream.getVideoTracks()[0];a&&a.stop()}const s=await j(!0,!0);h(a=>({...a,localStream:s,isScreenSharing:!1}))}else{const s=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});if(r.localStream){const a=r.localStream.getVideoTracks()[0];a&&r.localStream.removeTrack(a),r.localStream.addTrack(s.getVideoTracks()[0])}h(a=>({...a,localStream:r.localStream,isScreenSharing:!0}))}}catch(s){console.error("Error toggling screen share:",s)}},[r.localStream,r.isScreenSharing,j]);return n.useCallback((s,a)=>{setIncomingCall(s),h(o=>({...o,isInCall:!0,callType:a}))},[]),n.useEffect(()=>{r.remoteStream&&d.current&&(d.current.srcObject=r.remoteStream)},[r.remoteStream]),{callState:r,incomingCall:x,outgoingCall:M,localVideoRef:b,remoteVideoRef:d,startCall:g,acceptCall:l,rejectCall:m,endCall:v,toggleAudio:c,toggleVideo:T,toggleScreenShare:u,callUsers:L,getOnlineUsers:D}},Qe=({isOpen:r,callUser:h,callType:b,callState:d,incomingCall:p,outgoingCall:x,onAccept:M,onReject:L,onEnd:k,onToggleAudio:N,onToggleVideo:y,onToggleScreenShare:i,localVideoRef:I,remoteVideoRef:D})=>{const A=n.useRef(null);if(n.useEffect(()=>{p&&A.current?(A.current.loop=!0,A.current.play().catch(()=>{console.log("Ringtone file not found, using fallback notification")})):A.current&&(A.current.pause(),A.current.currentTime=0)},[p]),!r)return null;const j=h&&h.name&&h.name!=="User"?h:p?{name:`User ${(p.fromUserId||"").slice(-4)}`,id:p.fromUserId}:x?{name:`User ${(x.toUserId||"").slice(-4)}`,id:x.toUserId}:h||{name:"Unknown User",id:"unknown"},g=!!p,l=!!x&&!d.isCallActive;return e.jsxs("div",{className:"fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50",children:[e.jsx("audio",{ref:A,preload:"auto",children:e.jsx("source",{src:"/sounds/ringtone.mp3",type:"audio/mpeg"})}),e.jsxs("div",{className:"bg-[#161b22] rounded-xl p-8 w-full max-w-md mx-4 border border-gray-800",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs("div",{className:"relative mx-auto mb-6",children:[e.jsx("div",{className:"w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto",children:j!=null&&j.avatar?e.jsx("img",{src:j.avatar,alt:j.name,className:"w-24 h-24 rounded-full object-cover"}):e.jsx(ee,{className:"w-12 h-12 text-white"})}),g&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 border-2 border-blue-400 rounded-full animate-ping"}),e.jsx("div",{className:"absolute inset-0 border-2 border-blue-400 rounded-full animate-ping animation-delay-1000"})]})]}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:(j==null?void 0:j.name)||"Unknown"}),e.jsxs("p",{className:"text-gray-400",children:[g&&`Incoming ${p==null?void 0:p.callType} call`,l&&"Calling...",d.isCallActive&&`${d.callType} call`]}),d.isCallActive&&e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Call in progress..."})]}),b==="video"&&d.isCallActive&&e.jsxs("div",{className:"mb-6 relative",children:[e.jsxs("div",{className:"w-full h-64 bg-gray-900 rounded-lg overflow-hidden",children:[e.jsx("video",{ref:D,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover",style:{transform:"scaleX(-1)"}}),!d.remoteStream&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"w-16 h-16 text-gray-400 mx-auto mb-2"}),e.jsxs("p",{className:"text-gray-400",children:["Waiting for ",j==null?void 0:j.name,"..."]})]})})]}),e.jsx("div",{className:"absolute top-4 right-4 w-24 h-32 bg-gray-900 rounded-lg overflow-hidden border-2 border-white/20",children:e.jsx("video",{ref:I,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover",style:{transform:"scaleX(-1)"}})})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[g&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:L,className:"w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors",children:e.jsx(ie,{className:"w-8 h-8 text-white"})}),e.jsx("button",{onClick:M,className:"w-16 h-16 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center transition-colors",children:b==="audio"?e.jsx(ve,{className:"w-8 h-8 text-white"}):e.jsx(de,{className:"w-8 h-8 text-white"})})]}),l&&e.jsx("button",{onClick:L,className:"w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors",children:e.jsx(ie,{className:"w-8 h-8 text-white"})}),d.isCallActive&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:N,className:`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${d.isAudioEnabled?"bg-gray-600 hover:bg-gray-700":"bg-red-500 hover:bg-red-600"}`,children:d.isAudioEnabled?e.jsx(Me,{className:"w-6 h-6 text-white"}):e.jsx($e,{className:"w-6 h-6 text-white"})}),b==="video"&&e.jsx("button",{onClick:y,className:`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${d.isVideoEnabled?"bg-gray-600 hover:bg-gray-700":"bg-red-500 hover:bg-red-600"}`,children:d.isVideoEnabled?e.jsx(de,{className:"w-6 h-6 text-white"}):e.jsx(Re,{className:"w-6 h-6 text-white"})}),b==="video"&&e.jsx("button",{onClick:i,className:`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${d.isScreenSharing?"bg-blue-500 hover:bg-blue-600":"bg-gray-600 hover:bg-gray-700"}`,children:e.jsx(qe,{className:"w-6 h-6 text-white"})}),e.jsx("button",{onClick:k,className:"w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors",children:e.jsx(ie,{className:"w-8 h-8 text-white"})})]})]}),d.isCallActive&&e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-sm text-gray-400",children:[d.isAudioEnabled?"Microphone on":"Microphone off"," â€¢",b==="video"&&(d.isVideoEnabled?" Camera on":" Camera off"),d.isScreenSharing&&" â€¢ Screen sharing"]})})]})]})},He=({conversation:r,onBack:h,chatHook:b})=>{const{user:d}=me(),{messages:p,loading:x,sendMessage:M,fetchMessages:L,markMessagesAsRead:k,fetchConversationParticipants:N}=b,[y,i]=n.useState(""),[I,D]=n.useState(r.participants),[A,P]=n.useState([]),[j,g]=n.useState(!1),[l,m]=n.useState(!1),[v,c]=n.useState({}),[T,u]=n.useState(!1),s=n.useRef(null),a=n.useRef(null),o=n.useRef(null),_=n.useRef(null),{callState:E,incomingCall:R,outgoingCall:q,localVideoRef:H,remoteVideoRef:K,startCall:Q,acceptCall:te,rejectCall:Y,endCall:V,toggleAudio:W,toggleVideo:C,toggleScreenShare:Z}=Ke(),S=I.find(t=>t.id!==(d==null?void 0:d.id));n.useEffect(()=>{r.id&&L(r.id)},[r.id,L]),n.useEffect(()=>{r.id&&r.participants.length===0?(async()=>{const f=await N(r.id);D(f)})():D(r.participants)},[r.id,r.participants,N]),n.useEffect(()=>{r.id&&k(r.id)},[r.id,k]),n.useEffect(()=>{var t;(t=s.current)==null||t.scrollIntoView({behavior:"smooth"})},[p]),n.useEffect(()=>()=>{Object.values(v).forEach(t=>{URL.revokeObjectURL(t)})},[v]),n.useEffect(()=>{E.isInCall||u(!1)},[E.isInCall]),n.useEffect(()=>{const t=f=>{f.key==="Escape"&&(E.isInCall||R)&&(console.log("ðŸ”´ ESC key pressed - force ending call"),u(!0))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[E.isInCall,R]),n.useEffect(()=>{const t=f=>{(E.isInCall||R)&&f.detail===2&&(console.log("ðŸ”´ Double click detected - force ending call"),u(!0))};return document.addEventListener("dblclick",t),()=>document.removeEventListener("dblclick",t)},[E.isInCall,R]);const he=async()=>{if((y.trim()||A.length>0)&&r.id){g(!0);try{if(A.length>0){for(const t of A){const f=t.type.startsWith("image/"),w=f?"image":"file",F=await ye(t);F?await M(r.id,y.trim()||(f?"ðŸ“· Image":`ðŸ“Ž ${t.name}`),w,F,t.name,t.type):(console.error("Failed to upload file:",t.name),alert(`Failed to upload ${t.name}. Please try again.`))}P([])}else await M(r.id,y.trim());i("")}catch(t){console.error("Error sending message:",t),alert("Failed to send message. Please try again.")}finally{g(!1)}}},we=t=>{t.key==="Enter"&&he()},ye=async t=>{try{const f=Date.now(),w=Math.random().toString(36).substring(2,15),F=t.name.split(".").pop(),z=`${f}_${w}.${F}`,{data:$,error:B}=await U.storage.from("chat-files").upload(`conversation_${r.id}/${z}`,t,{cacheControl:"3600",upsert:!1});if(B)return console.error("Error uploading file:",B),null;const{data:O}=U.storage.from("chat-files").getPublicUrl($.path);return O.publicUrl}catch(f){return console.error("Error in uploadFileToStorage:",f),null}},se=t=>{if(!t)return;const f=[],w=10*1024*1024,F=["image/jpeg","image/png","image/gif","image/webp"],z=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];Array.from(t).forEach($=>{if($.size>w){alert(`File ${$.name} is too large. Maximum size is 10MB.`);return}$.type.startsWith("image/")?F.includes($.type)?f.push($):alert(`Image format ${$.type} is not supported.`):z.includes($.type)?f.push($):alert(`File format ${$.type} is not supported.`)}),f.length>0&&(P($=>[...$,...f]),f.forEach($=>{if($.type.startsWith("image/")){const B=URL.createObjectURL($);c(O=>({...O,[$.name]:B}))}}))},je=t=>{const f=A[t];if(f&&f.type.startsWith("image/")){const w=v[f.name];w&&URL.revokeObjectURL(w),c(F=>{const z={...F};return delete z[f.name],z})}P(w=>w.filter((F,z)=>z!==t))},ge=t=>t.type.startsWith("image/")?e.jsx(pe,{className:"w-4 h-4"}):e.jsx(Pe,{className:"w-4 h-4"}),Ne=t=>{if(t===0)return"0 Bytes";const f=1024,w=["Bytes","KB","MB","GB"],F=Math.floor(Math.log(t)/Math.log(f));return parseFloat((t/Math.pow(f,F)).toFixed(2))+" "+w[F]},ae=t=>{t.preventDefault(),t.stopPropagation(),m(!0)},re=t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.contains(t.relatedTarget)||m(!1)},ne=t=>{t.preventDefault(),t.stopPropagation()},le=t=>{t.preventDefault(),t.stopPropagation(),m(!1);const f=t.dataTransfer.files;f&&f.length>0&&se(f)},Ce=async()=>{if(S){const t={id:S.id,name:S.name,avatar:S.avatar};console.log("ðŸ“ž Starting audio call with user:",t),Q(t,"audio")}},ke=async()=>{if(S){const t={id:S.id,name:S.name,avatar:S.avatar};console.log("ðŸ“ž Starting video call with user:",t),Q(t,"video")}},_e=()=>{te()},Se=()=>{Y()},Ee=()=>{console.log("ðŸ”´ Ending call..."),u(!0);try{V()}catch(t){console.error("Error ending call:",t)}try{R&&Y()}catch(t){console.error("Error rejecting call:",t)}setTimeout(()=>{u(!0)},100)},Te=t=>{const w=Math.floor((new Date().getTime()-t.getTime())/(1e3*60));return w<1?"Just now":w<60?`${w}m ago`:w<1440?`${Math.floor(w/60)}h ago`:t.toLocaleDateString()},Ie=(t,f)=>{var $,B;const w=t.senderId===(d==null?void 0:d.id),F=f===0||(($=p[f-1])==null?void 0:$.senderId)!==t.senderId,z=f===p.length-1||new Date(t.createdAt).getTime()-new Date(((B=p[f+1])==null?void 0:B.createdAt)||0).getTime()>3e5;return e.jsx("div",{className:`flex ${w?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`flex ${w?"flex-row-reverse":"flex-row"} items-end space-x-2 max-w-[80%]`,children:[F&&!w&&e.jsx("div",{className:"w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center flex-shrink-0",children:t.sender.avatar?e.jsx("img",{src:t.sender.avatar,alt:t.sender.name,className:"w-8 h-8 rounded-full object-cover"}):e.jsx("span",{className:"text-gray-300 text-xs font-medium",children:t.sender.name?t.sender.name[0].toUpperCase():"?"})}),F&&w&&e.jsx("div",{className:"w-8"}),e.jsxs("div",{className:`${w?"items-end":"items-start"} flex flex-col`,children:[F&&!w&&e.jsx("p",{className:"text-xs text-gray-400 mb-1 px-1",children:t.sender.name}),e.jsxs("div",{className:`px-4 py-2 rounded-2xl max-w-xs ${w?"bg-blue-600 text-white rounded-br-md":"bg-gray-700 text-white rounded-bl-md"}`,children:[t.messageType==="text"&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content}),t.messageType==="image"&&e.jsxs("div",{children:[e.jsx("img",{src:t.fileUrl||"",alt:"Shared image",className:"max-w-xs max-h-64 rounded-lg object-cover cursor-pointer",onClick:()=>window.open(t.fileUrl||"","_blank"),onError:O=>{var X;console.error("Failed to load image:",t.fileUrl),O.currentTarget.style.display="none";const J=document.createElement("div");J.className="p-4 bg-red-900/20 border border-red-500 rounded-lg text-red-300 text-sm",J.textContent="Failed to load image",(X=O.currentTarget.parentNode)==null||X.appendChild(J)},onLoad:()=>{console.log("Image loaded successfully:",t.fileUrl)}}),t.content&&t.content!=="ðŸ“· Image"&&e.jsx("p",{className:"text-sm mt-2",children:t.content})]}),t.messageType==="file"&&e.jsxs("div",{className:"flex items-center space-x-2 p-2 bg-gray-600/20 rounded-lg",children:[e.jsx("div",{className:"flex-shrink-0",children:ge({type:t.fileType||""})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:t.fileName}),t.content&&t.content!==`ðŸ“Ž ${t.fileName}`&&e.jsx("p",{className:"text-sm opacity-80",children:t.content})]}),e.jsx("button",{onClick:async()=>{if(t.fileUrl)try{const O=await fetch(t.fileUrl);if(O.ok){const J=await O.blob(),X=window.URL.createObjectURL(J),G=document.createElement("a");G.href=X,G.download=t.fileName||"download",document.body.appendChild(G),G.click(),window.URL.revokeObjectURL(X),document.body.removeChild(G)}else window.open(t.fileUrl,"_blank")}catch(O){console.error("Error downloading file:",O),window.open(t.fileUrl,"_blank")}},className:"flex-shrink-0 p-1 hover:bg-gray-600/40 rounded transition-colors",title:"Download file",children:e.jsx(xe,{className:"w-4 h-4"})})]})]}),z&&e.jsx("p",{className:`text-xs text-gray-400 mt-1 px-1 ${w?"text-right":"text-left"}`,children:Te(t.createdAt)})]})]})},t.id)};return S?e.jsxs("div",{className:`flex flex-col h-full bg-[#0d1117] overflow-hidden relative ${l?"bg-blue-500/10":""}`,onDragEnter:ae,onDragLeave:re,onDragOver:ne,onDrop:le,children:[l&&e.jsx("div",{className:"absolute inset-0 bg-blue-500/20 backdrop-blur-sm flex items-center justify-center z-50 border-2 border-dashed border-blue-400 rounded-lg m-2",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-blue-500/30 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(pe,{className:"w-8 h-8 text-blue-400"})}),e.jsx("h3",{className:"text-lg font-semibold text-white mb-2",children:"Drop files here"}),e.jsx("p",{className:"text-blue-300 text-sm",children:"Release to upload images and documents"})]})}),e.jsx("div",{className:"p-4 border-b border-gray-800 bg-[#161b22] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center space-x-4 min-w-0",children:[e.jsx("button",{onClick:h,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors lg:hidden",children:e.jsx(Oe,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center",children:S.avatar?e.jsx("img",{src:S.avatar,alt:S.name,className:"w-10 h-10 rounded-full object-cover"}):e.jsx("span",{className:"text-gray-300 font-medium",children:S.name?S.name[0].toUpperCase():"?"})}),S.lastActive&&new Date().getTime()-S.lastActive.getTime()<3e5&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-[#161b22]"})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsx("h2",{className:"text-white font-medium truncate",children:S.name}),e.jsxs("p",{className:"text-sm text-gray-400 truncate",children:[S.college&&S.college.length>12?`${S.college.substring(0,12)}...`:S.college," â€¢ ",S.branch]})]})]}),e.jsxs("div",{className:"flex items-center space-x-1 flex-shrink-0",children:[e.jsx("button",{onClick:Ce,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",title:"Start audio call",children:e.jsx(ve,{className:"w-5 h-5 text-gray-400"})}),e.jsx("button",{onClick:ke,className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",title:"Start video call",children:e.jsx(de,{className:"w-5 h-5 text-gray-400"})}),e.jsx("button",{className:"p-2 hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx(Le,{className:"w-5 h-5 text-gray-400"})})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 bg-[#0d1117] min-h-0 overflow-x-hidden",onDragEnter:ae,onDragLeave:re,onDragOver:ne,onDrop:le,children:[x&&p.length===0&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}),p.length===0&&!x&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-full flex items-center justify-center mb-4",children:e.jsx(ue,{className:"w-8 h-8 text-blue-400"})}),e.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Start the conversation"}),e.jsxs("p",{className:"text-gray-400 text-sm",children:["Send a message to ",e.jsx("span",{className:"font-medium text-blue-400",children:S.name})," to get started"]})]}),p.map((t,f)=>Ie(t,f)),e.jsx("div",{ref:s})]}),A.length>0&&e.jsx("div",{className:"p-4 bg-[#161b22] border-t border-gray-800",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:A.map((t,f)=>e.jsxs("div",{className:"flex items-center space-x-2 bg-[#0d1117] rounded-lg p-2 border border-gray-700",children:[t.type.startsWith("image/")?e.jsx("img",{src:v[t.name]||"",alt:t.name,className:"w-8 h-8 rounded object-cover",onError:w=>{console.error("Failed to load image preview:",t.name),w.currentTarget.style.display="none"}}):e.jsx("div",{className:"w-8 h-8 bg-gray-600 rounded flex items-center justify-center",children:ge(t)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-white truncate",children:t.name}),e.jsx("p",{className:"text-xs text-gray-400",children:Ne(t.size)})]}),e.jsx("button",{onClick:()=>je(f),className:"p-1 hover:bg-gray-600 rounded transition-colors",children:e.jsx(oe,{className:"w-3 h-3 text-gray-400"})})]},f))})}),e.jsxs("div",{className:`p-4 border-t border-gray-800 bg-[#161b22] flex-shrink-0 overflow-hidden ${l?"border-blue-400 bg-blue-500/5":""}`,onDragEnter:ae,onDragLeave:re,onDragOver:ne,onDrop:le,children:[e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("button",{className:"p-2 hover:bg-gray-700 rounded-lg transition-colors flex-shrink-0",onClick:()=>{var t;return(t=_.current)==null?void 0:t.click()},children:e.jsx(Fe,{className:"w-5 h-5 text-gray-400"})}),e.jsx("button",{className:"p-2 hover:bg-gray-700 rounded-lg transition-colors flex-shrink-0",onClick:()=>{var t;return(t=o.current)==null?void 0:t.click()},children:e.jsx(xe,{className:"w-5 h-5 text-gray-400"})}),e.jsx("div",{className:"flex-1 relative min-w-0",children:e.jsx("input",{ref:a,type:"text",placeholder:`Message ${S.name}...`,value:y,onChange:t=>i(t.target.value),onKeyPress:we,className:"w-full px-4 py-3 bg-[#0d1117] border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"})}),e.jsx("button",{onClick:he,disabled:!y.trim()&&A.length===0||j,className:"p-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white rounded-lg transition-colors disabled:cursor-not-allowed flex-shrink-0",children:j?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Ve,{className:"w-5 h-5"})})]}),e.jsx("input",{ref:_,type:"file",accept:"image/*",multiple:!0,onChange:t=>se(t.target.files),className:"hidden"}),e.jsx("input",{ref:o,type:"file",accept:".pdf,.doc,.docx,.txt,.xls,.xlsx",multiple:!0,onChange:t=>se(t.target.files),className:"hidden"})]}),e.jsx(Qe,{isOpen:(E.isInCall||!!R)&&!T,callUser:S||null,callType:E.callType,callState:E,incomingCall:R,outgoingCall:q,onAccept:_e,onReject:Se,onEnd:Ee,onToggleAudio:W,onToggleVideo:C,onToggleScreenShare:Z,localVideoRef:H,remoteVideoRef:K})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("p",{className:"text-gray-400",children:"Invalid conversation"})})},Je=()=>{const{user:r}=me(),[h,b]=n.useState([]),[d,p]=n.useState(null),[x,M]=n.useState([]),[L,k]=n.useState(!1),[N,y]=n.useState(null),i=()=>r||{id:"550e8400-e29b-41d4-a716-446655440000",name:"Test User",username:"testuser",email:"alice.johnson@axiscolleges.in",college:"Axis Colleges",branch:"Computer Science",year:2023,bio:"Test user for chat functionality",isVerified:!0,isAnonymous:!1,avatar:null,skills:[],achievements:[],joinedAt:new Date,lastActive:new Date},I=n.useCallback(async()=>{var m,v,c;const l=i();if(l){k(!0);try{const T=l.id,{data:u,error:s}=await U.from("conversation_participants").select("conversation_id, last_read_at").eq("user_id",T);if(s){console.error("Error fetching conversations:",s),s.code==="42P01"?y("Chat tables not found. Please run the database migration first."):y(s.message||"Failed to fetch conversations"),b([]);return}const a=[];if(u&&u.length>0){const o=new Map;for(const _ of u){const E=_.conversation_id;if(!o.has(E)){const{data:R}=await U.from("conversation_participants").select("user_id").eq("conversation_id",E),q=[];if(R&&R.length>0)for(const V of R){const{data:W}=await U.from("profiles").select("id, user_id, name, username, email, college, branch, year, avatar_url, is_online, last_seen").eq("id",V.user_id).limit(1),C=W==null?void 0:W[0];C&&q.push({id:C.user_id,name:C.name,username:C.username||((m=C.email)==null?void 0:m.split("@")[0])||C.name.toLowerCase().replace(/\s+/g,""),email:C.email,college:C.college,branch:C.branch,year:C.year,bio:"",isVerified:!1,isAnonymous:!1,avatar:C.avatar_url,skills:[],achievements:[],joinedAt:new Date,lastActive:C.last_seen?new Date(C.last_seen):new Date})}const{data:H}=await U.from("messages").select("id, sender_id, content, message_type, file_name, created_at").eq("conversation_id",E).order("created_at",{ascending:!1}).limit(1);let K=null;if(H&&H.length>0){const V=H[0],{data:W}=await U.from("profiles").select("id, user_id, name, username, email, college, branch, year, avatar_url").eq("id",V.sender_id).limit(1);if(W&&W.length>0){const C=W[0],Z={id:C.user_id,name:C.name,username:C.username||((v=C.email)==null?void 0:v.split("@")[0])||C.name.toLowerCase().replace(/\s+/g,""),email:C.email,college:C.college,branch:C.branch,year:C.year,bio:"",isVerified:!1,isAnonymous:!1,avatar:C.avatar_url,skills:[],achievements:[],joinedAt:new Date,lastActive:new Date};K={id:V.id,conversationId:E,senderId:Z.id,sender:Z,content:V.content,messageType:V.message_type,fileUrl:null,fileName:V.file_name,fileType:null,isRead:!1,createdAt:new Date(V.created_at),updatedAt:new Date(V.created_at)}}}const{data:Q}=await U.from("profiles").select("user_id").eq("id",l.id).limit(1),te=(c=Q==null?void 0:Q[0])==null?void 0:c.user_id,Y=q.filter(V=>V.id!==te);o.set(E,{id:E,participants:Y,lastMessage:K,unreadCount:0,createdAt:new Date,updatedAt:K?K.createdAt:new Date})}}a.push(...o.values())}b(a)}catch(T){console.error("Error fetching conversations:",T),y(T instanceof Error?T.message:"Failed to fetch conversations"),b([])}finally{k(!1)}}},[]),D=n.useCallback(async l=>{var v;if(!i())return[];try{const{data:c}=await U.from("conversation_participants").select("user_id").eq("conversation_id",l);if(!c||c.length===0)return[];const T=[];for(const u of c){const{data:s}=await U.from("profiles").select("id, user_id, name, username, email, college, branch, year, avatar_url, is_online, last_seen").eq("id",u.user_id).limit(1),a=s==null?void 0:s[0];a&&T.push({id:a.user_id,name:a.name,username:a.username||((v=a.email)==null?void 0:v.split("@")[0])||a.name.toLowerCase().replace(/\s+/g,""),email:a.email,college:a.college,branch:a.branch,year:a.year,bio:"",isVerified:!1,isAnonymous:!1,avatar:a.avatar_url,skills:[],achievements:[],joinedAt:new Date,lastActive:a.last_seen?new Date(a.last_seen):new Date})}return T}catch(c){return console.error("Error fetching conversation participants:",c),[]}},[]),A=n.useCallback(async l=>{const m=i();if(console.log("ðŸ” startConversation called with:",{otherUserId:l,currentUser:m==null?void 0:m.id}),!m)return console.log("âŒ No current user found"),null;try{const{data:v,error:c}=await U.from("conversation_participants").select("conversation_id").eq("user_id",m.id);if(c){if(console.log("âŒ Error checking existing conversations:",c),c.code==="42P01")y("Chat tables not found. Please run the database migration first.");else throw c;return null}console.log("ðŸ” Existing conversations:",v);let T=null;if(v&&v.length>0)for(const o of v){const{data:_}=await U.from("conversation_participants").select("user_id").eq("conversation_id",o.conversation_id).eq("user_id",l).limit(1);if(_==null?void 0:_[0]){T=o;break}}if(T)return console.log("âœ… Found existing conversation:",T.conversation_id),T.conversation_id;console.log("ðŸ†• Creating new conversation...");const{data:u,error:s}=await U.from("conversations").insert({}).select().single();if(s)throw console.log("âŒ Error creating conversation:",s),s;console.log("âœ… Created new conversation:",u),console.log("ðŸ‘¥ Adding participants...");const{error:a}=await U.from("conversation_participants").insert([{conversation_id:u.id,user_id:m.id},{conversation_id:u.id,user_id:l}]);if(a)throw console.log("âŒ Error adding participants:",a),a;return console.log("âœ… Participants added successfully"),u.id}catch(v){return console.error("Error starting conversation:",v),y(v instanceof Error?v.message:"Failed to start conversation"),null}},[]),P=n.useCallback(async(l,m,v="text",c,T,u)=>{const s=i();if(s)try{const a=s.id,{data:o,error:_}=await U.from("messages").insert({conversation_id:l,sender_id:a,content:m,message_type:v,file_url:c,file_name:T,file_type:u}).select().single();if(_)throw _;const E={id:o.id,conversationId:o.conversation_id,senderId:o.sender_id,sender:s,content:o.content,messageType:o.message_type,fileUrl:o.file_url,fileName:o.file_name,fileType:o.file_type,isRead:o.is_read,createdAt:new Date(o.created_at),updatedAt:new Date(o.updated_at)};M(R=>[...R,E])}catch(a){console.error("Error sending message:",a),y(a instanceof Error?a.message:"Failed to send message")}},[]),j=n.useCallback(async l=>{var v;if(i()){k(!0);try{const{data:c,error:T}=await U.from("messages").select(`
          id,
          conversation_id,
          sender_id,
          content,
          message_type,
          file_url,
          file_name,
          file_type,
          is_read,
          created_at,
          updated_at
        `).eq("conversation_id",l).order("created_at",{ascending:!0});if(T)throw T;const u=[];if(c&&c.length>0)for(const s of c){const{data:a}=await U.from("profiles").select("id, user_id, name, username, email, college, branch, year, avatar_url").eq("id",s.sender_id).limit(1),o=a==null?void 0:a[0];o&&u.push({id:s.id,conversationId:s.conversation_id,senderId:s.sender_id,sender:{id:o.user_id,name:o.name,username:o.username||((v=o.email)==null?void 0:v.split("@")[0])||o.name.toLowerCase().replace(/\s+/g,""),email:o.email,college:o.college,branch:o.branch,year:o.year,bio:"",isVerified:!1,isAnonymous:!1,avatar:o.avatar_url,skills:[],achievements:[],joinedAt:new Date,lastActive:new Date},content:s.content,messageType:s.message_type,fileUrl:s.file_url,fileName:s.file_name,fileType:s.file_type,isRead:s.is_read,createdAt:new Date(s.created_at),updatedAt:new Date(s.updated_at)})}M(u)}catch(c){console.error("Error fetching messages:",c),y(c instanceof Error?c.message:"Failed to fetch messages")}finally{k(!1)}}},[]),g=n.useCallback(async l=>{const m=i();if(m)try{await U.from("messages").update({is_read:!0}).eq("conversation_id",l).neq("sender_id",m.id),M(v=>v.map(c=>c.conversationId===l&&c.senderId!==m.id?{...c,isRead:!0}:c))}catch(v){console.error("Error marking messages as read:",v)}},[]);return n.useEffect(()=>{if(!i())return;const m=U.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},v=>{const c=v.new;h.some(u=>u.id===c.conversation_id)&&U.from("profiles").select("*").eq("user_id",c.sender_id).single().then(({data:u})=>{if(u){const s={id:c.id,conversationId:c.conversation_id,senderId:c.sender_id,sender:{id:u.id,name:u.name,username:u.username,email:u.email,college:u.college,branch:u.branch,year:u.year,bio:u.bio||"",isVerified:u.is_verified,isAnonymous:u.is_anonymous,avatar:u.avatar_url,skills:u.skills||[],achievements:u.achievements||[],joinedAt:new Date(u.created_at),lastActive:new Date(u.updated_at)},content:c.content,messageType:c.message_type,fileUrl:c.file_url,fileName:c.file_name,fileType:c.file_type,isRead:c.is_read,createdAt:new Date(c.created_at),updatedAt:new Date(c.updated_at)};M(a=>[...a,s])}})}).subscribe();return()=>{m.unsubscribe()}},[h]),{conversations:h,activeConversation:d,messages:x,loading:L,error:N,fetchConversations:I,fetchConversationParticipants:D,startConversation:A,sendMessage:P,fetchMessages:j,markMessagesAsRead:g,setActiveConversation:p}},mt=()=>{const[r,h]=n.useState(null),b=Je();De.useEffect(()=>{b.fetchConversations()},[]);const d=x=>{h(x)},p=()=>{h(null)};return e.jsxs("div",{className:"h-[calc(100vh-120px)] md:h-[calc(100vh-80px)] flex bg-[#0d1117]",children:[e.jsx("div",{className:`${r?"hidden lg:flex":"flex"} flex-col w-full lg:w-80 xl:w-96 bg-[#161b22] border-r border-gray-800 h-full`,children:e.jsx(Be,{onConversationSelect:d,chatHook:b})}),e.jsx("div",{className:`${r?"flex":"hidden lg:flex"} flex-col flex-1 bg-[#0d1117] h-full`,children:r?e.jsx(He,{conversation:r,onBack:p,chatHook:b}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-sm px-6",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx("svg",{className:"w-10 h-10 text-blue-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Choose a conversation from the list to start messaging"})]})})})]})};export{mt as default};
